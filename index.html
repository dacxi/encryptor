<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Encryptor / Decryptor - Dacxi</title>
    <link type="text/css" rel="stylesheet" href="style.css" />
    <link type="text/css" rel="stylesheet" href="tailwind.dko.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet"> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
    <!-- <script src="passchecker.js"></script> -->
  </head>

  <body>
    <div class="flex flex-center flex-col h-full">
      <div class="sidebars">
        <div id="header" class="text-center">
          <img src="images/dacxi-logo.svg" width="300" />
          <p class="uppercase my-25 color-1 text-lg">File Encryptor AND Decryptor</p>

          <div class="flex w-full">
            <button id="btnDivEncrypt" onClick="javascript:switchdiv('encrypt');">Encrypt a File</button>
            <button id="btnDivDecrypt" onClick="javascript:switchdiv('decrypt');">Decrypt a File</button>
          </div>
        </div>

        <div class="container" id="divEncryptfile">
          <!-- <h2>Encrypt a File</h2> -->
          <!-- <p>
        To encrypt a file, enter a password and drop the file to be encrypted into the dropzone below. The file will then be encrypted using
        the password, then you'll be given an opportunity to save the encrypted file to your system.
      </p> -->

          <div>
            <div
              class="dropzone"
              id="encdropzone"
              ondrop="drop_handler(event);"
              ondragover="dragover_handler(event);"
              ondragend="dragend_handler(event);"
              onclick="javascript:encfileElem.click();"
            >
              <p>
                Drag and drop the file to be encrypted here,<br />
                or click to select file.
              </p>
              <p><span id="spnencfilename"></span></p>
            </div>
            <input type="file" id="encfileElem" style="display: none" onchange="selectfile(this.files)" />
          </div>

          <div class="divTable">
            <div class="divTableBody">
              <div class="divTableRow">
                <div class="divTableCell">Encryption Password</div>
                <div class="divTableCell">
                  <input id="txtEncpassphrase" type="password" autocomplete="off" size="30" onkeyup="javascript:encvalidate();" value="" />
                </div>
              </div>
              <div class="divTableRow">
                <div class="divTableCell">Confirm Password</div>
                <div class="divTableCell">
                  <input
                    id="txtEncpassphraseretype"
                    type="password"
                    autocomplete="off"
                    size="30"
                    onkeyup="javascript:encvalidate();"
                    value=""
                  />
                </div>
                <div class="divTableCell"><small class="greenspan" id="spnCheckretype"></small></div>
              </div>
            </div>
          </div>

          <p></p>

          <div class="divTable">
            <div class="divTableBody">
              <div class="divTableRow">
                <div class="divTableCell">
                  <button id="btnEncrypt" class="w-full p-10" onclick="javascript:encryptfile();" disabled>Encrypt and Download File</button>
                </div>
                <div class="divTableCell"><span id="spnEncstatus"></span></div>
              </div>
            </div>
          </div>

          <p></p>

          <div>
            <a id="aEncsavefile" hidden><button>Save Encrypted File</button></a>
          </div>

          <p></p>
        </div>

        <div class="container mt-20" id="divDecryptfile">
          <div>
            <div
              class="dropzone"
              id="decdropzone"
              ondrop="drop_handler(event);"
              ondragover="dragover_handler(event);"
              ondragend="dragend_handler(event);"
              onclick="javascript:decfileElem.click();"
            >
              <p>
                Drag and drop the file to be decrypted here,<br />
                or click to select file.
              </p>

              <p><span id="spndecfilename"></span></p>
            </div>
            <input type="file" id="decfileElem" style="display: none" onchange="selectfile(this.files)" />
          </div>

          <div class="divTable">
            <div class="divTableBody">
              <div class="divTableRow">
                <div class="divTableCell">Decryption Password</div>
                <div class="divTableCell">
                  <input id="txtDecpassphrase" type="password" autocomplete="off" size="30" onkeyup="javascript:decvalidate();" value="" />
                </div>
              </div>
            </div>
          </div>

          <div class="divTable">
            <div class="divTableBody">
              <div class="divTableRow">
                <div class="divTableCell"><button id="btnDecrypt" class="w-full p-10 mt-20" onclick="javascript:decryptfile();" disabled>Decrypt and Download File</button></div>
                <div class="divTableCell"><span id="spnDecstatus"></span></div>
              </div>
            </div>
          </div>

          <p></p>

          <div>
            <a id="aDecsavefile" hidden><button>Save Decrypted File</button></a>
          </div>

          <p></p>
        </div>
      </div>
    </div>
  </body>
</html>

<script type="text/javascript">
  var mode = null;
  var objFile = null;
  switchdiv("encrypt");

  function switchdiv(t) {
    if (t == "encrypt") {
      divEncryptfile.style.display = "block";
      divDecryptfile.style.display = "none";
      btnDivEncrypt.disabled = true;
      btnDivDecrypt.disabled = false;
      mode = "encrypt";
    } else if (t == "decrypt") {
      divEncryptfile.style.display = "none";
      divDecryptfile.style.display = "block";
      btnDivEncrypt.disabled = false;
      btnDivDecrypt.disabled = true;
      mode = "decrypt";
    }
  }

  function encvalidate() {
    if (txtEncpassphrase.value.length >= 14) {
      if (txtEncpassphrase.value == txtEncpassphraseretype.value) {
        spnCheckretype.classList.add("greenspan");
        spnCheckretype.classList.remove("redspan");
        spnCheckretype.innerHTML = "";
      } else {
        spnCheckretype.innerHTML = "Confirmation password must match encryption password";
      }
    } else {
      spnCheckretype.classList.remove("greenspan");
      spnCheckretype.classList.add("redspan");
      spnCheckretype.innerHTML = "Please use a strong password with a minimum of 14 characters";
    }

    if (txtEncpassphrase.value.length >= 14 && txtEncpassphrase.value == txtEncpassphraseretype.value && objFile) {
      btnEncrypt.disabled = false;
    } else {
      btnEncrypt.disabled = true;
    }
  }

  function decvalidate() {
    if (txtDecpassphrase.value.length > 0 && objFile) {
      btnDecrypt.disabled = false;
    } else {
      btnDecrypt.disabled = true;
    }
  }

  //drag and drop functions:
  //https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/File_drag_and_drop
  function drop_handler(ev) {
    console.log("Drop");
    ev.preventDefault();
    // If dropped items aren't files, reject them
    var dt = ev.dataTransfer;
    if (dt.items) {
      // Use DataTransferItemList interface to access the file(s)
      for (var i = 0; i < dt.items.length; i++) {
        if (dt.items[i].kind == "file") {
          var f = dt.items[i].getAsFile();
          console.log("... file[" + i + "].name = " + f.name);
          objFile = f;
        }
      }
    } else {
      // Use DataTransfer interface to access the file(s)
      for (var i = 0; i < dt.files.length; i++) {
        console.log("... file[" + i + "].name = " + dt.files[i].name);
      }
      objFile = file[0];
    }
    displayfile();
    if (mode == "encrypt") {
      encvalidate();
    } else if (mode == "decrypt") {
      decvalidate();
    }
  }

  function dragover_handler(ev) {
    console.log("dragOver");
    // Prevent default select and drag behavior
    ev.preventDefault();
  }

  function dragend_handler(ev) {
    console.log("dragEnd");
    // Remove all of the drag data
    var dt = ev.dataTransfer;
    if (dt.items) {
      // Use DataTransferItemList interface to remove the drag data
      for (var i = 0; i < dt.items.length; i++) {
        dt.items.remove(i);
      }
    } else {
      // Use DataTransfer interface to remove the drag data
      ev.dataTransfer.clearData();
    }
  }

  function selectfile(Files) {
    objFile = Files[0];
    displayfile();
    if (mode == "encrypt") {
      encvalidate();
    } else if (mode == "decrypt") {
      decvalidate();
    }
  }

  function displayfile() {
    var s;
    var sizes = ["Bytes", "KB", "MB", "GB", "TB"];
    var bytes = objFile.size;
    var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
    if (i == 0) {
      s = bytes + " " + sizes[i];
    } else {
      s = (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
    }

    if (mode == "encrypt") {
      spnencfilename.textContent = objFile.name + " (" + s + ")";
    } else if (mode == "decrypt") {
      spndecfilename.textContent = objFile.name + " (" + s + ")";
    }
  }

  function readfile(file) {
    return new Promise((resolve, reject) => {
      var fr = new FileReader();
      fr.onload = () => {
        resolve(fr.result);
      };
      fr.readAsArrayBuffer(file);
    });
  }

  async function encryptfile() {
    btnEncrypt.disabled = true;

    var plaintextbytes = await readfile(objFile).catch(function (err) {
      console.error(err);
    });
    var plaintextbytes = new Uint8Array(plaintextbytes);

    var pbkdf2iterations = 10000;
    var passphrasebytes = new TextEncoder("utf-8").encode(txtEncpassphrase.value);
    var pbkdf2salt = window.crypto.getRandomValues(new Uint8Array(8));

    var passphrasekey = await window.crypto.subtle
      .importKey("raw", passphrasebytes, { name: "PBKDF2" }, false, ["deriveBits"])
      .catch(function (err) {
        console.error(err);
      });
    console.log("passphrasekey imported");

    var pbkdf2bytes = await window.crypto.subtle
      .deriveBits({ name: "PBKDF2", salt: pbkdf2salt, iterations: pbkdf2iterations, hash: "SHA-256" }, passphrasekey, 384)
      .catch(function (err) {
        console.error(err);
      });
    console.log("pbkdf2bytes derived");
    pbkdf2bytes = new Uint8Array(pbkdf2bytes);

    keybytes = pbkdf2bytes.slice(0, 32);
    ivbytes = pbkdf2bytes.slice(32);

    var key = await window.crypto.subtle
      .importKey("raw", keybytes, { name: "AES-CBC", length: 256 }, false, ["encrypt"])
      .catch(function (err) {
        console.error(err);
      });
    console.log("key imported");

    var cipherbytes = await window.crypto.subtle.encrypt({ name: "AES-CBC", iv: ivbytes }, key, plaintextbytes).catch(function (err) {
      console.error(err);
    });

    if (!cipherbytes) {
      spnEncstatus.classList.add("redspan");
      spnEncstatus.innerHTML = "<p>Error encrypting file.  See console log.</p>";
      return;
    }

    console.log("plaintext encrypted");
    cipherbytes = new Uint8Array(cipherbytes);

    var resultbytes = new Uint8Array(cipherbytes.length + 16);
    resultbytes.set(new TextEncoder("utf-8").encode("Salted__"));
    resultbytes.set(pbkdf2salt, 8);
    resultbytes.set(cipherbytes, 16);

    var blob = new Blob([resultbytes], { type: "application/download" });
    var blobUrl = URL.createObjectURL(blob);
    aEncsavefile.href = blobUrl;
    aEncsavefile.download = objFile.name + ".encrypted";
    aEncsavefile.click();

    spnEncstatus.classList.add("greenspan");
    spnEncstatus.innerHTML = "<p>File encrypted successfully.</p>";
    // aEncsavefile.hidden = false;
  }

  async function decryptfile() {
    btnDecrypt.disabled = true;

    var cipherbytes = await readfile(objFile).catch(function (err) {
      console.error(err);
    });
    var cipherbytes = new Uint8Array(cipherbytes);

    var pbkdf2iterations = 10000;
    var passphrasebytes = new TextEncoder("utf-8").encode(txtDecpassphrase.value);
    var pbkdf2salt = cipherbytes.slice(8, 16);

    var passphrasekey = await window.crypto.subtle
      .importKey("raw", passphrasebytes, { name: "PBKDF2" }, false, ["deriveBits"])
      .catch(function (err) {
        console.error(err);
      });
    console.log("passphrasekey imported");

    var pbkdf2bytes = await window.crypto.subtle
      .deriveBits({ name: "PBKDF2", salt: pbkdf2salt, iterations: pbkdf2iterations, hash: "SHA-256" }, passphrasekey, 384)
      .catch(function (err) {
        console.error(err);
      });
    console.log("pbkdf2bytes derived");
    pbkdf2bytes = new Uint8Array(pbkdf2bytes);

    keybytes = pbkdf2bytes.slice(0, 32);
    ivbytes = pbkdf2bytes.slice(32);
    cipherbytes = cipherbytes.slice(16);

    var key = await window.crypto.subtle
      .importKey("raw", keybytes, { name: "AES-CBC", length: 256 }, false, ["decrypt"])
      .catch(function (err) {
        console.error(err);
      });
    console.log("key imported");

    var plaintextbytes = await window.crypto.subtle.decrypt({ name: "AES-CBC", iv: ivbytes }, key, cipherbytes).catch(function (err) {
      console.error(err);
    });

    if (!plaintextbytes) {
      spnDecstatus.classList.add("redspan");
      spnDecstatus.innerHTML = "<p>Error decrypting file.  Password may be incorrect.</p>";
      return;
    }

    console.log("ciphertext decrypted");
    plaintextbytes = new Uint8Array(plaintextbytes);

    var blob = new Blob([plaintextbytes], { type: "application/download" });
    var blobUrl = URL.createObjectURL(blob);
    aDecsavefile.href = blobUrl;
    aDecsavefile.download = objFile.name.replace(".encrypted","");
    aDecsavefile.click();

    spnDecstatus.classList.add("greenspan");
    spnDecstatus.innerHTML = "<p>File decrypted successfully!.</p>";
    // aDecsavefile.hidden = false;
  }
</script>
